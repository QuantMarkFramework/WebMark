{% extends "rest_framework/base.html" %}

{% block title %}QuantMark2 Detail: {{ result.id }}{% endblock %}

{% block style %}
{{ block.super }}
<style type="text/css">
  table.data th,
  td {
    padding-right: 5px;
    padding-left: 5px;
  }

  th.right,
  td.right {
    text-align: right;
  }
</style>
{% endblock %}

{% block content %}
<div class="starter-template">
  <h1>Experiment {{ result.id }}</h1>
  <div>
    {% if request.user == result.user %}
      <button id="deletion" type="button" class="btn btn-danger">Delete</button>
      {% if result.public %}
        <button id="make_private" type="button" class="btn btn-danger">Make private</button>
      {% else %}
        <button id="make_public" type="button" class="btn btn-danger">Make public</button>
      {% endif %}
    {% endif %}
    <br><br>
  </div>
  <div>
    <p><b>About the experiment:</b></p>
    {% if request.user == result.user %}
      <label for="txtarea">Some relevant information about the experiment:</label><br>
      <textarea id="txtarea" class="form-control" rows="3">{{ result.info }}</textarea><br><br>
      <label for="githubLink">GitHub repository:</label><br>
      <input id="githubLink" type="text" value="{{ result.github_link }}"><br><br>
      <label for="articleLink">Article:</label><br>
      <input id="articleLink" type="text" value="{{ result.article_link }}"><br><br>
      <button id="modify_info" type="button" class="btn-primary">Save</button>
    {% else %}
      <div>
        {{ result.info }}
      </div>
    {% endif %}
  </div>
  <br><br>
  <div class="row">
    <div class="col-sm-6">
      <div class="card">
        <div class="card-body">
          <h2 class="card-title">Experiment data</h2>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">uploader / user: {{ result.user }}</li>
            <li class="list-group-item">date: {{ result.created|date:"Y-m-d H:i" }}</li>
            <li class="list-group-item">GitHub repository: <br><a href="{{ result.github_link }}">{{ result.github_link }}</a></li>
            <li class="list-group-item">Article: <br><a href="{{ result.article_link }}">{{ result.article_link }}</a></li>
            <li class="list-group-item">tequila version: {{ result.tqversion }}</li>
            <li class="list-group-item">public: {{ result.public }}</li>
          </ul>
        </div>
      </div>
    </div>
    <div class="col-sm-6">
      <div class="card">
        <div class="card-body">
          <h2 class="card-title">Optimizer data</h2>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">optimizer: {{ result.optimizer }}</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-sm-6">
      <div class="card">
        <div class="card-body">
          <h2 class="card-title">Circuit data</h2>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">Something</li>
          </ul>
        </div>
      </div>
    </div>
    <div class="col-sm-6">
      <div class="card">
        <div class="card-body">
          <h2 class="card-title">Molecule data</h2>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">molecule: {{ result.molecule }}</li>
            <li class="list-group-item">basis set: {{ result.basis_set }}</li>
            <li class="list-group-item">transformation: {{ result.transformation }}</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-body">
      <h2 class="card-title">Circuit</h2>
    </div>
  </div>
  <div>
    <div id="chart_energy_distance"></div>
    <div id="chart_energy_iteration"></div>
  </div>
</div>
{% endblock %}

{% block script %}
{{ block.super }}
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/js-cookie@3.0.0/dist/js.cookie.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
  google.charts.load('current', { 'packages': ['corechart', 'controls', 'line'] });
  google.charts.setOnLoadCallback(drawChart);

  function drawChart() {
    drawEnergyDistanceChart()
    drawEnergyIterationChart()
  }

  function drawEnergyDistanceChart() {
    var distances = {{ distances }}
  var energies = {{ energies }}
  var fci_distances = {{ fci_distances }}
  var fci_energies = {{ fci_energies }}

  var name = "{{ name }}"

  var data = new google.visualization.DataTable({
    cols: [{ id: 'distance', label: 'Distance', type: 'number' },
    { id: 'energy', label: name, type: 'number' },
    { id: 'fci', 'label': 'FCI def2-QZVPPD', type: 'number' }]
  });

  for (i = 0; i < energies.length; i++) {
    data.addRow([distances[i], energies[i], NaN])
  };

  for (i = 0; i < fci_distances.length; i++) {
    data.addRow([fci_distances[i], NaN, fci_energies[i]])
  };

  // Form the wrapper that holds the chart and its options.
  var chart = new google.visualization.ChartWrapper({
    'chartType': 'LineChart',
    dataTable: data,
    'containerId': 'chart_energy_distance',
    'options': {
      width: 1000,
      height: 1000,
      pointsVisible: true,
      title: 'Calculated energy against distance',
      titleTextStyle: {fontSize: 30},
      legend: { position: 'labeled' },
      hAxis: { title: 'Distance', id: 'distance', type: 'number' },
      vAxis: { title: "Energy", id: 'energy', type: 'number' },
      explorer: {
        keepInBounds: true,
      },
    }
  });

  chart.draw();
  }

  function drawEnergyIterationChart() {
    var energyIterations = {{ iterationEnergies }}
  var distances = {{ distances }}

  var data = new google.visualization.DataTable();
  data.addColumn('number', 'Iteration');

  for (i = 0; i < energyIterations.length; i++) {
    data.addColumn('number', distances[i])
  }

  maxIterations = Math.max.apply(null, energyIterations.map(elem => elem.length));

  for (i = 0; i < maxIterations; i++) {
    energies_it = energyIterations.map(elem => elem[i])
    var row = [i + 1].concat(energies_it)
    data.addRow(row)
  };

  // Form the wrapper that holds the chart and its options.
  var chart = new google.visualization.ChartWrapper({
    'chartType': 'LineChart',
    dataTable: data,
    containerId: 'chart_energy_iteration',
    options: {
      width: 1000,
      height: 1000,
      title: 'Energy against iteration for each distance',
      titleTextStyle: {fontSize: 30},
      hAxis: { title: 'Iteration', id: 'iteration', type: 'number' },
      vAxis: { title: 'Energy', id: 'energy_per_iteration', type: 'number' },
      explorer: {
        keepInBounds: true,
      },
    }
  })
  chart.draw();
  }

  /*
    * Dummy control wrapper that can be later used to implement controls on the chart.
    * Should be added as its own <div>.
    * 
    var controller = new google.visualization.ControlWrapper({
      'controlType': 'CategoryFilter',
      'containerId': 'controller',
      'options': {
        explorer: {
          actions: ['dragToZoom', 'rightClickToReset'],
        },
        filterColumnLabel: 'Name',
        'ui': {
          'chartType': 'LineChart',
        }
      }
    });  
    */

  /* 
  * Dashboard needed to join ControlWrapper with ChartWrapper.
  *
  var dashboard = new google.visualization.Dashboard(
    document.getElementById('dashboard_div'));
  */

  /* Joining the ControlWrapper and ChartWrapper to the dashboard and drawing the dashboard.
  * This is to be activated, if a controller is to be used.
  * 
  dashboard.bind(controller, chart);
  dashboard.draw(data);
  */
  $('#deletion').click(function () {
    if (window.confirm("Delete the experiment permanently?")) {
      const csrftoken = Cookies.get('csrftoken')
      return axios
        .delete(`{{ path_prefix }}/api/{{ result.id }}/delete/`, {
          headers: {
            'X-CSRFToken': csrftoken
          }
        })
        .then(response => {
          console.log(response.status);
          window.location = window.location.origin;
        })
        .catch(error => {
          console.log(error);
        });
    }
  });

  $('#make_public').click(function () {
    if (window.confirm("The experiment is currently set as private.\nDo you want to set it public?")) {
      const csrftoken = Cookies.get('csrftoken')
      return axios
        .post(`{{ path_prefix }}/api/{{ result.id }}/change_publicity/`, {
          'boolean': true
        },
          {
            headers: {
              'X-CSRFToken': csrftoken
            }
          })
        .then(response => {
          console.log(response.status);
          window.location = window.location;
        })
        .catch(error => {
          console.log(error);
        });
    }
  });

  $('#make_private').click(function () {
    if (window.confirm("The experiment is currently set as public.\nDo you want to set it private?")) {
      const csrftoken = Cookies.get('csrftoken')
      return axios
        .post(`{{ path_prefix }}/api/{{ result.id }}/change_publicity/`, {
          'boolean': false
        },
          {
            headers: {
              'X-CSRFToken': csrftoken
            }
          })
        .then(response => {
          console.log(response.status);
          window.location = window.location;
        })
        .catch(error => {
          console.log(error);
        });
    }
  });

  $('#modify_info').click(function () {
    if (window.confirm("Save the experiment's information?")) {
      const csrftoken = Cookies.get('csrftoken')
      return axios
        .post(`{{ path_prefix }}/api/{{ result.id }}/modify_info/`, {
          'info': $("#txtarea").val(),
          'github_link': $("#githubLink").val(),
          'article_link': $("#articleLink").val()
        },
          {
            headers: {
              'X-CSRFToken': csrftoken
            }
          })
        .then(response => {
          console.log(response.status);
          window.location = window.location;
        })
        .catch(error => {
          console.log(error);
        });
      }
  });
</script>
{% endblock %}